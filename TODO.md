# Context Collector 开发任务清单

## MVP 核心功能开发 (P0 - 必须完成)

### 🏗️ 项目基础设施

- [ ] **项目脚手架搭建**
  - [ ] 创建 SwiftUI macOS 应用项目
  - [ ] 配置 Info.plist (辅助功能权限说明)
  - [ ] 设置项目基本结构和文件组织
  - [ ] 配置 App Sandbox 和权限请求

- [ ] **基础模型和工具类**
  - [ ] 创建 `CapturePreferences` 数据模型
  - [ ] 创建 `ContextCollectorError` 错误类型定义
  - [ ] 创建工具函数 (文件名清洗、路径操作等)
  - [ ] 设置日志和调试工具

### 📁 存储系统 (优先级最高)

- [ ] **StorageService 核心实现**
  - [ ] 实现根目录初始化 (`~/ContextCollector`)
  - [ ] 实现目录结构创建 (`inbox/`, `projects/`)
  - [ ] 实现日期目录生成 (`YYYY-MM-DD`)
  - [ ] 实现文件路径生成逻辑
  - [ ] 实现文件名清洗 (非法字符替换)
  - [ ] 实现重名冲突处理 (`-a`, `-b`, `-c` 后缀)
  - [ ] 实现原子文件写入 (临时文件 + 重命名)
  - [ ] 添加错误处理和恢复机制
  - [ ] 编写单元测试

- [ ] **ProjectsService 实现**
  - [ ] 实现项目目录扫描功能
  - [ ] 实现新项目创建 (创建文件夹)
  - [ ] 实现项目名称验证
  - [ ] 实现项目列表刷新
  - [ ] 添加项目删除功能 (可选)
  - [ ] 编写单元测试

### ⌨️ 全局快捷键系统

- [ ] **HotkeyService 实现**
  - [ ] 实现 CGEventTap 全局键监听
  - [ ] 实现双击 ⌘C 检测逻辑 (时间窗口)
  - [ ] 实现权限检查和请求
  - [ ] 实现事件过滤和处理
  - [ ] 添加服务启动/停止控制
  - [ ] 处理权限被拒绝的情况
  - [ ] 添加调试日志和错误处理
  - [ ] 编写集成测试

### 📋 剪贴板操作

- [ ] **ClipboardService 实现**
  - [ ] 实现纯文本读取功能
  - [ ] 实现富文本到纯文本转换
  - [ ] 实现 HTML 到纯文本转换
  - [ ] 处理空剪贴板情况
  - [ ] 保持文本格式 (换行、缩进)
  - [ ] 添加错误处理
  - [ ] 编写单元测试

### 🎨 用户界面开发

- [ ] **主窗口界面 (CaptureWindow)**
  - [ ] 创建窗口基本结构 (左右分栏)
  - [ ] 实现项目选择器 (左侧面板)
    - [ ] 项目列表显示
    - [ ] Inbox 默认选项
    - [ ] 新建项目功能
    - [ ] 项目选择状态管理
  - [ ] 实现标题输入框
  - [ ] 集成 MarkdownTextView (右侧面板)
  - [ ] 添加窗口控制按钮
  - [ ] 实现响应式布局

- [ ] **MarkdownTextView 自定义组件**
  - [ ] NSTextView 封装为 SwiftUI 组件
  - [ ] 实现文本双向绑定
  - [ ] 实现 ⌘B 粗体包裹功能
    - [ ] 检测选中文本
    - [ ] 智能包裹/取消包裹 `**text**`
    - [ ] 处理无选择时的行为
  - [ ] 实现行注释功能
    - [ ] 行首 `//` 添加/移除
    - [ ] 多行选择批量操作
    - [ ] 智能检测已有注释
  - [ ] 实现快捷键处理
    - [ ] ⌘S 保存回调
    - [ ] ⌘/ 注释切换
    - [ ] Esc 窗口关闭
  - [ ] 添加文本变更监听
  - [ ] 优化光标和选择状态管理

### 🧠 状态管理

- [ ] **CaptureViewModel 实现**
  - [ ] 实现基本状态属性 (@Published)
  - [ ] 实现窗口显示/隐藏逻辑
  - [ ] 实现剪贴板内容加载
  - [ ] 实现保存操作协调
  - [ ] 实现表单重置功能
  - [ ] 添加保存状态反馈 (成功/失败)
  - [ ] 实现错误处理和用户提示
  - [ ] 添加数据验证

### ⚙️ 偏好设置系统

- [ ] **PreferencesService 实现**
  - [ ] 实现偏好设置存储/读取
  - [ ] 实现默认值管理
  - [ ] 实现设置验证逻辑
  - [ ] 添加设置变更通知

- [ ] **偏好设置界面**
  - [ ] 创建设置窗口
  - [ ] 实现根目录选择器
  - [ ] 实现双击阈值滑块 (300-600ms)
  - [ ] 实现保存后行为选择
  - [ ] 实现设置重置功能

### 🔗 应用集成

- [ ] **App.swift 主入口**
  - [ ] 配置应用生命周期
  - [ ] 初始化各个服务
  - [ ] 设置全局快捷键监听
  - [ ] 处理首次启动引导
  - [ ] 实现权限检查和请求流程

- [ ] **服务协调和通信**
  - [ ] 连接 HotkeyService 和 CaptureViewModel
  - [ ] 连接 ClipboardService 和内容加载
  - [ ] 连接 StorageService 和保存操作
  - [ ] 实现错误处理链
  - [ ] 添加服务状态监控

## 优化和增强功能 (P1 - 可选完成)

### 🎯 用户体验优化

- [ ] **智能功能增强**
  - [ ] `//` 注释二次触发自动移除
  - [ ] `⌘B` 二次触发智能去包裹
  - [ ] 最近使用项目快速选择
  - [ ] 自动保存草稿功能

- [ ] **界面体验优化**
  - [ ] 添加保存成功动画反馈
  - [ ] 优化窗口出现位置和动画
  - [ ] 添加键盘导航支持
  - [ ] 实现主题/外观设置

### 🔧 实用工具功能

- [ ] **文件操作增强**
  - [ ] 保存后复制文件路径到剪贴板
  - [ ] 快速打开保存的文件
  - [ ] 文件预览功能
  - [ ] 批量操作支持

- [ ] **快捷命令系统**
  - [ ] `/assets` 插入资产根路径占位符
  - [ ] `/date` 插入当前日期
  - [ ] `/time` 插入当前时间
  - [ ] 自定义快捷命令配置

### 📊 统计和分析

- [ ] **使用统计**
  - [ ] 收集基本使用数据
  - [ ] 文件保存统计
  - [ ] 项目使用频率统计
  - [ ] 生成使用报告

## 质量保证 (QA)

### ✅ 测试开发

- [ ] **单元测试**
  - [ ] StorageService 测试套件
  - [ ] ClipboardService 测试套件
  - [ ] ProjectsService 测试套件
  - [ ] 工具函数测试套件

- [ ] **集成测试**
  - [ ] 端到端工作流测试
  - [ ] 权限处理测试
  - [ ] 错误恢复测试
  - [ ] 性能基准测试

- [ ] **用户测试场景**
  - [ ] 双击 ⌘C 触发测试
  - [ ] 文本编辑功能测试
  - [ ] 文件保存和命名测试
  - [ ] 项目管理功能测试
  - [ ] 偏好设置功能测试
  - [ ] 边界条件测试

### 🐛 错误处理和边界情况

- [ ] **权限相关**
  - [ ] 辅助功能权限被拒绝
  - [ ] 文件系统权限不足
  - [ ] Sandbox 限制处理

- [ ] **系统资源**
  - [ ] 磁盘空间不足
  - [ ] 内存不足处理
  - [ ] 超长文本处理
  - [ ] 特殊字符处理

- [ ] **用户输入验证**
  - [ ] 非法文件名处理
  - [ ] 空内容处理
  - [ ] 项目名称验证
  - [ ] 路径安全检查

### 📝 文档和部署

- [ ] **代码文档**
  - [ ] API 文档生成
  - [ ] 内联代码注释
  - [ ] 架构决策记录 (ADR)
  - [ ] 故障排除指南

- [ ] **用户文档**
  - [ ] 用户使用指南
  - [ ] 常见问题解答
  - [ ] 快捷键参考卡片
  - [ ] 视频演示教程

- [ ] **发布准备**
  - [ ] 应用签名和公证
  - [ ] 安装包制作
  - [ ] 自动更新机制
  - [ ] 崩溃报告收集

## 性能和稳定性 (P2)

### ⚡ 性能优化

- [ ] **内存管理**
  - [ ] 大文本内容的内存优化
  - [ ] NSTextView 内存泄漏检查
  - [ ] 服务对象生命周期优化
  - [ ] 缓存策略实现

- [ ] **响应性优化**
  - [ ] 异步文件操作
  - [ ] UI 响应性监控
  - [ ] 长时间操作进度反馈
  - [ ] 后台任务管理

### 🔒 安全和隐私

- [ ] **数据安全**
  - [ ] 敏感数据处理审查
  - [ ] 日志安全检查
  - [ ] 文件权限设置
  - [ ] 网络通信审计 (确保无网络请求)

## 任务优先级说明

### 🔴 P0 (MVP - 必须完成)
核心功能实现，确保基本工作流可用

### 🟡 P1 (增强功能 - 根据时间决定)
提升用户体验的功能，可以在 MVP 后逐步添加

### 🟢 P2 (优化功能 - 长期规划)
性能优化和长期维护相关的任务

## 开发时间预估

- **P0 核心功能**: 2-3 周
- **P1 增强功能**: 1-2 周
- **测试和优化**: 1 周
- **文档和发布**: 3-5 天

**总预估时间**: 4-6 周 (根据开发经验和可投入时间调整)